<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-size: 13px;
        }
        @media print {
            .content {
                width: 100%;
                height: auto;
            }
        }
        #command  {
            display: flex;
            align-items: center;
            justify-content: center;
            padding-top: 20px;
            gap: 10px;
        }
        .order-head{
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        .d-none {
            display: none;
        }
        .d-flex {
            display: flex;
        }
        .pagination {
            align-items: center;
        }

        .pagination button, .pagination input {
            margin: 0 2px;
        }
        .container {
            width: 210mm;
            padding: 12mm;
            margin: 10mm auto;
            box-sizing: border-box;
        }
        .container h1, .container p {
            word-wrap: break-word; /* Đảm bảo văn bản không vượt quá chiều rộng của trang */
        }
        header {
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            margin-top: -2cm;
        }
        .header2 {
            max-width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: -2cm;
        }
        .header2 p{
            margin: 3px 0px;
        }
        header img {
            max-width: 150px;
            height: auto;
            margin-top: 10px;
            padding: 0px;
        }
        .left-header {
            text-align: left;
            vertical-align: middle;
            padding:0px 0px 3px 0px;
        }
        .right-header {
            text-align: right;
            vertical-align: middle;
            padding:0px 0px 10px 0px;
        }
        .company-info {
            text-align: center;
        }

        .company-info p {
            margin-bottom: -10px;
            word-wrap: break-word;
        }

        #currentDate {
            margin-top: 30px;
            font-style: italic;
            text-align: right;
        }

        table {
            max-width: 100%;
            height: auto; 
            border-collapse: collapse;
        }
        
        .product-table th, td {
            border: 1px solid #dddddd;
            padding: 3px 5px;
            
        }
        .product-table th {
            background-color: #f2f2f2;
        }
        #info-table td{
            padding: 5px;
        }
        .text-center {
            text-align: center;
            vertical-align: middle;
            padding:3px 5px;
        }
        .text-left {
            text-align: left;
            vertical-align: middle;
            padding:3px 5px;
        }
        .text-right {
            text-align: right;
            vertical-align: middle;
            padding:3px 5px;
        }
        .p-tb-0{
            padding: 0px;
        }
        #productItem {
            display: block;
            margin: 0 auto;
            width: 300px;
        }

   
        .totalOrder label {
            font-weight: bold;
            text-align: right;
            font-size: 18px;
        }

        .totalOrder p {
            text-align: left;
            white-space-collapse: preserve;
            letter-spacing: 0.2px;
        }

        footer {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
        }

        .left-footer {
            margin: 0px 10px;
            text-align: center;
        }
        .right-footer{
            margin:0px 10px;
            text-align: center;
        }
        

    </style>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  
    <script>
        // modify from https://github.com/mozilla/pdf.js/blob/master/examples/node/pdf2svg.js
        pdf_table_extractor_progress = function(result){
        };

        pdf_table_extractor = function(doc,pageNumber){
        var numPages = doc.numPages;
        var result = {};
        result.pageTables = [];
        result.numPages = numPages;
        result.currentPages = 0;

        var transform_fn = function(m1, m2) {
            return [
            m1[0] * m2[0] + m1[2] * m2[1],
            m1[1] * m2[0] + m1[3] * m2[1],
            m1[0] * m2[2] + m1[2] * m2[3],
            m1[1] * m2[2] + m1[3] * m2[3],
            m1[0] * m2[4] + m1[2] * m2[5] + m1[4],
            m1[1] * m2[4] + m1[3] * m2[5] + m1[5]
            ];
        };

        var applyTransform_fn = function(p, m) {
            var xt = p[0] * m[0] + p[1] * m[2] + m[4];
            var yt = p[0] * m[1] + p[1] * m[3] + m[5];
            return [xt, yt];
        };

        var lastPromise = Promise.resolve(); // will be used to chain promises
        var loadPage = function (pageNum) {
            return doc.getPage(pageNum).then(function (page) {
            var verticles = [];
            var horizons = [];
            var merges = {};
            var merge_alias = {};
            var transformMatrix = [1,0,0,1,0,0];;
            var transformStack = [];

            return page.getOperatorList().then(function (opList) {
                    // Get rectangle first
                    var showed = {};
                    var REVOPS = [];
                    for (var op in pdfjsLib.OPS) {
                        REVOPS[pdfjsLib.OPS[op]] = op;
                    }

                    var strokeRGBColor = null;
                    var fillRGBColor = null;
                    var current_x, current_y;
                    var edges = [];
                    var line_max_width = 2;
                    var lineWidth = null;

                    while (opList.fnArray.length) {
                        var fn = opList.fnArray.shift();
                        var args = opList.argsArray.shift();
                        if (pdfjsLib.OPS.constructPath == fn) {
                            while (args[0].length) {
                                op = args[0].shift();
                                if (op == pdfjsLib.OPS.rectangle) {
                                    x = args[1].shift();
                                    y = args[1].shift();
                                    width = args[1].shift();
                                    height = args[1].shift();
                                    if (Math.min(width, height) < line_max_width) {
                                        edges.push({y:y, x:x, width:width, height:height, transform: transformMatrix});
                                    }
                                } else if (op == pdfjsLib.OPS.moveTo) {
                                    current_x = args[1].shift();
                                    current_y = args[1].shift();
                                } else if (op == pdfjsLib.OPS.lineTo) {
                                    x = args[1].shift();
                                    y = args[1].shift();

                                    if(lineWidth == null) {
                                        if (current_x == x) {
                                            edges.push({
                                                y: Math.min(y, current_y), 
                                                x: Math.min(x, current_x),
                                                height: Math.abs(y - current_y),
                                                transform: transformMatrix
                                            });
                                        } else if (current_y == y) {
                                            edges.push({
                                                x: Math.min(x, current_x), 
                                                y: Math.min(y, current_y),
                                                width: Math.abs(x - current_x), 
                                                transform: transformMatrix
                                            });
                                        }
                                    } else {
                                        if (current_x == x) {
                                            edges.push({y: Math.min(y, current_y), x: x - lineWidth / 2, width: lineWidth, height: Math.abs(y - current_y), transform: transformMatrix});
                                        } else if (current_y == y) {
                                            edges.push({x: Math.min(x, current_x), y: y - lineWidth / 2, height: lineWidth, width: Math.abs(x - current_x), transform: transformMatrix});
                                        }
                                    }
                                    current_x = x;
                                    current_y = y;
                                } else {
                                    // throw ('constructPath ' + op);
                                }
                            }
                        } else if (pdfjsLib.OPS.save == fn) {
                            transformStack.push(transformMatrix);
                        } else if (pdfjsLib.OPS.restore == fn ){
                            transformMatrix = transformStack.pop();
                        } else if (pdfjsLib.OPS.transform == fn) {
                            transformMatrix = transform_fn(transformMatrix, args);
                        } else if (pdfjsLib.OPS.setStrokeRGBColor == fn) {
                            strokeRGBColor = args;
                        } else if (pdfjsLib.OPS.setFillRGBColor == fn) {
                            fillRGBColor = args;
                        } else if (pdfjsLib.OPS.setLineWidth == fn) {
                            lineWidth = args[0];
                        } else if (['eoFill'].indexOf(REVOPS[fn]) >= 0) {
                        } else if ('undefined' === typeof(showed[fn])) {
                            showed[fn] = REVOPS[fn];
                        } else {
                        }
                    }

                    edges = edges.map(function(edge){
                            var point1 = applyTransform_fn([edge.x, edge.y], edge.transform);
                            var point2 = applyTransform_fn([edge.x + edge.width, edge.y + edge.height], edge.transform);
                            return {
                                x: Math.min(point1[0], point2[0]),
                                y: Math.min(point1[1], point2[1]),
                                width: Math.abs(point1[0] - point2[0]),
                                height: Math.abs(point1[1] - point2[1]),
                            };
                    });
                    // merge rectangle to verticle lines and horizon lines
                    edges1 = JSON.parse(JSON.stringify(edges));
                    edges1.sort(function(a, b){ return (a.x - b.x) || (a.y - b.y); });
                    edges2 = JSON.parse(JSON.stringify(edges));
                    edges2.sort(function(a, b){ return (a.y - b.y) || (a.x - b.x); });

                    // get verticle lines
                    var current_x = null;
                    var current_y = null;
                    var current_height = 0;
                    var lines = [];
                    var lines_add_verticle = function(lines, top, bottom){
                        var hit = false;
                        for (var i = 0; i < lines.length; i ++) {
                            if (lines[i].bottom < top || lines[i].top > bottom) {
                                continue;
                            }
                            hit = true;

                            top = Math.min(lines[i].top, top);
                            bottom = Math.max(lines[i].bottom, bottom);
                            new_lines = [];
                            if (i > 1) {
                                news_lines = lines.slice(0, i - 1);
                            }
                            new_lines = new_lines.concat(lines.slice(i + 1));
                            lines = new_lines;
                            return lines_add_verticle(lines, top, bottom);
                        }
                        if (!hit) {
                            lines.push({top: top, bottom: bottom});
                        }
                        return lines;
                    };

                    while (edge = edges1.shift()) {
                        // skip horizon lines
                        if (edge.width > line_max_width) {
                            continue;
                        }

                        // new verticle lines
                        if (null === current_x || edge.x - current_x > line_max_width) {
                            if (current_height > line_max_width) {
                                lines = lines_add_verticle(lines, current_y, current_y + current_height);
                            }
                            if (null !== current_x && lines.length) {
                                verticles.push({x: current_x, lines: lines});
                            }
                            current_x = edge.x;
                            current_y = edge.y;
                            current_height = 0;
                            lines = [];
                        }

                        if (Math.abs(current_y + current_height - edge.y) < 10) {
                            current_height = edge.height + edge.y - current_y;
                        } else {
                            if (current_height > line_max_width) {
                                lines = lines_add_verticle(lines, current_y, current_y + current_height);
                            }
                            current_y = edge.y;
                            current_height = edge.height;
                        }
                    }
                    if (current_height > line_max_width) {
                        lines = lines_add_verticle(lines, current_y, current_y + current_height);
                    }

                    // no table
                    if (current_x === null || lines.length == 0) {
                        return {};
                    }
                    verticles.push({x: current_x, lines: lines});

                    // Get horizon lines
                    current_x = null;
                    current_y = null;
                    var current_width = 0;
                    var lines_add_horizon = function(lines, left, right){
                        var hit = false;
                        for (var i = 0; i < lines.length; i ++) {
                            if (lines[i].right < left || lines[i].left > right) {
                                continue;
                            }
                            hit = true;

                            left = Math.min(lines[i].left, left);
                            right = Math.max(lines[i].right, right);
                            new_lines = [];
                            if (i > 1) {
                                news_lines = lines.slice(0, i - 1);
                            }
                            new_lines = new_lines.concat(lines.slice(i + 1));
                            lines = new_lines;
                            return lines_add_horizon(lines, left, right);
                        }
                        if (!hit) {
                            lines.push({left: left, right: right});
                        }
                        return lines;
                    };

                    while (edge = edges2.shift()) {
                        if (edge.height > line_max_width) {
                            continue;
                        }
                        if (null === current_y || edge.y - current_y > line_max_width) {
                            if (current_width > line_max_width) {
                                lines = lines_add_horizon(lines, current_x, current_x + current_width);
                            }
                            if (null !== current_y && lines.length) {
                                horizons.push({y: current_y, lines: lines});
                            }
                            current_x = edge.x;
                            current_y = edge.y;
                            current_width = 0;
                            lines = [];
                        }

                        if (Math.abs(current_x + current_width - edge.x) < 10) {
                            current_width = edge.width + edge.x - current_x;
                        } else {
                            if (current_width > line_max_width) {
                                lines = lines_add_horizon(lines, current_x, current_x + current_width);
                            }
                            current_x = edge.x;
                            current_width = edge.width;
                        }
                    }
                    if (current_width > line_max_width) {
                        lines = lines_add_horizon(lines, current_x, current_x + current_width);
                    }
                    // no table
                    if (current_y === null || lines.length == 0) {
                        return {};
                    }
                    horizons.push({y: current_y, lines: lines});

                    var search_index = function(v, list) {
                        for (var i = 0; i < list.length; i ++) {
                            if (Math.abs(list[i] - v) < 5) {
                                return i;
                            }
                        }
                        return -1;
                    };

                    // handle merge cells
                    x_list = verticles.map(function(a){ return a.x; });

                    // check top_out and bottom_out
                    var y_list = horizons.map(function(a){ return a.y; }).sort(function(a, b) { return b - a; });
                    var y_max = verticles
                        .map(function(verticle) { return verticle.lines[0].bottom; })
                        .sort().reverse()[0];
                    var y_min = verticles
                        .map(function(verticle) { return verticle.lines[verticle.lines.length - 1].top; })
                        .sort()[0];
                    var top_out = search_index(y_min, y_list) == -1 ? 1 : 0;
                    var bottom_out = search_index(y_max, y_list) == -1 ? 1 : 0;

                    var verticle_merges = {};
                    // skip the 1st lines and final lines
                    for (var r = 0; r < horizons.length - 2 + top_out + bottom_out; r ++) {
                        hor = horizons[bottom_out + horizons.length - r - 2];
                        lines = hor.lines.slice(0);
                        col = search_index(lines[0].left, x_list);
                        if (col != 0) {
                            for (var c = 0; c < col; c ++) {
                                verticle_merges[[r, c].join('-')] = {row: r, col: c, width: 1, height: 2};
                            }
                        }
                        while (line = lines.shift()) {
                            left_col = search_index(line.left, x_list);
                            right_col = search_index(line.right, x_list);
                            if (left_col != col) {
                                for (var c = col; c < left_col; c ++) {
                                    verticle_merges[[r, c].join('-')] = {row: r, col: c, width: 1, height: 2};
                                }
                            }
                            col = right_col;
                        }
                        if (col != verticles.length - 1 + top_out) {
                            for (var c = col; c < verticles.length - 1 + top_out; c ++) {
                                verticle_merges[[r, c].join('-')] = {row: r, col: c, width: 1, height: 2};
                            }
                        }
                    }

                    while (true) {
                        var merged = false;
                        for (var r_c in verticle_merges) {
                            var m = verticle_merges[r_c];
                            var final_id = [m.row + m.height - 1, m.col + m.width - 1].join('-');
                            if ('undefined' !== typeof(verticle_merges[final_id])) {
                                verticle_merges[r_c].height += verticle_merges[final_id].height - 1;
                                delete(verticle_merges[final_id]);
                                merged = true;
                                break;
                            }
                        }
                        if (!merged) {
                            break;
                        }
                    }

                    var horizon_merges = {};

                    for (var c = 0; c < verticles.length - 2; c ++) {
                        ver = verticles[c + 1];
                        lines = ver.lines.slice(0);
                        row = search_index(lines[0].bottom, y_list) + bottom_out;
                        if (row != 0) {
                            for (var r = 0; r < row; r ++) {
                                horizon_merges[[r, c].join('-')] = {row: r, col: c, width: 2, height: 1};
                            }
                        }
                        while (line = lines.shift()) {
                            top_row = search_index(line.top, y_list);
                            if (top_row == -1) {
                                top_row = y_list.length + bottom_out;
                            } else {
                                top_row += bottom_out;
                            }
                            bottom_row = search_index(line.bottom, y_list) + bottom_out;
                            if (bottom_row != row) {
                                for (var r = bottom_row; r < row; r ++) {
                                    horizon_merges[[r, c].join('-')] = {row: r, col: c, width: 2, height: 1};
                                }
                            }
                            row = top_row;
                        }
                        if (row != horizons.length - 1 + bottom_out + top_out) {
                            for (var r = row; r < horizons.length - 1 + bottom_out + top_out; r ++) {
                                horizon_merges[[r, c].join('-')] = {row: r, col: c, width: 2, height: 1};
                            }
                        }
                    }
                    if (top_out) {
                        horizons.unshift({y: y_min, lines: []});
                    }
                    if (bottom_out) {
                        horizons.push({y:y_max, lines:[]});
                    }

                    while (true) {
                        var merged = false;
                        for (var r_c in horizon_merges) {
                            var m = horizon_merges[r_c];
                            var final_id = [m.row + m.height - 1, m.col + m.width - 1].join('-');
                            if ('undefined' !== typeof(horizon_merges[final_id])) {
                                horizon_merges[r_c].width += horizon_merges[final_id].width - 1;
                                delete(horizon_merges[final_id]);
                                merged = true;
                                break;
                            }
                        }
                        if (!merged) {
                            break;
                        }
                    }
                    merges = verticle_merges;
                    for (var id in horizon_merges) {
                        if ('undefined' !== typeof(merges[id])) {
                            merges[id].width = horizon_merges[id].width;
                        } else {
                            merges[id] = horizon_merges[id];
                        }
                    }
                    for (var id in merges) {
                            for (var c = 0; c < merges[id].width; c ++) {
                                for (var r = 0; r < merges[id].height; r ++) {
                                    if (c == 0 && r == 0) {
                                        continue;
                                    }
                                    delete(merges[[r + merges[id].row, c + merges[id].col].join('-')]);
                                }
                            }
                    }

                    merge_alias = {};
                    for (var id in merges) {
                        for (var c = 0; c < merges[id].width; c ++) {
                            for (var r = 0; r < merges[id].height; r ++) {
                                if (r == 0 && c == 0) {
                                    continue;
                                }
                                merge_alias[[merges[id].row + r, merges[id].col + c].join('-')] = [merges[id].row, merges[id].col].join('-');
                            }
                        }
                    }
            }).then(function(){
                return page.getTextContent().then(function (content) {
                        tables = [];
                        table_pos = [];
                        for (var i = 0; i < horizons.length - 1; i ++) {
                            tables[i] = [];
                            table_pos[i] = [];
                            for (var j = 0; j < verticles.length - 1; j ++) {
                                tables[i][j] = '';
                                table_pos[i][j] = null;
                            }
                        }
                        while (item = content.items.shift()) {
                            x = item.transform[4];
                            y = item.transform[5];

                            var col = -1;
                            for (var i = 0; i < verticles.length - 1 ; i ++)  {
                                if (x >= verticles[i].x && x < verticles[i + 1].x) {
                                    col = i;
                                    break;
                                }
                            }
                            if (col == -1) {
                                continue;
                            }
                            var row = -1;
                            for (var i = 0; i < horizons.length - 1 ; i ++)  {
                                if (y >= horizons[i].y && y < horizons[i + 1].y) {
                                    row = horizons.length - i - 2;
                                    break;
                                }
                            }
                            if (row == -1) {
                                continue;
                            }

                            if ('undefined' !== typeof(merge_alias[row + '-' + col])) {
                                id = merge_alias[row + '-' + col];
                                row = id.split('-')[0];
                                col = id.split('-')[1];
                            }
                            if (null !== table_pos[row][col] && Math.abs(table_pos[row][col] - y) > 5) {
                                tables[row][col] += "\n";
                            }
                            table_pos[row][col] = y;
                            tables[row][col] += item.str;
                        }
                        if (tables.length) {
                            result.pageTables.push({
                                    page: pageNum,
                                    tables: tables,
                                    merges: merges,
                                    merge_alias: merge_alias,
                                    width: verticles.length - 1,
                                    height: horizons.length - 1,
                            });
                        }
                        result.currentPages ++;
                        if ('function' === typeof(pdf_table_extractor_progress)) {
                            pdf_table_extractor_progress(result);
                        }
                });
            });
            });
        };

       // for (var i = 1; i <= numPages; i++) {
            lastPromise = lastPromise.then(loadPage.bind(null, pageNumber));
       // }
        return lastPromise.then(function(){
                return result;
        });
        };
    </script>
</head>
<body>
    <div id="command">
        <div>
            
            <button  style="background-color: lightblue;" onclick="document.getElementById('pdfFileInput').click()">Chọn hóa đơn</button>
            
            <input type="file" id="pdfFileInput"  style="display:none" title="chọn hóa đơn" accept="application/pdf">
           
        </div>
        
        <div class="pagination d-none">
            <label >Trang</label>
            <input type="number" id="currentPage" value="1" min="1" max="10" style="width: 30px; text-align: center;" oninput="goToPage()">
            <label id="numPages"></label>
        </div>
        <button id="btnOrderDownload">Tải Đơn đặt hàng</button>
        <button id="btnProductDownload">Tải Phiếu giao hàng</button>
    </div>
    <label id="filename" style="margin-top: 10px; color: blue;height: 10px; text-align: center;display: flex;justify-content: center;"></label>
<hr/>

<div class="container" id="orderContent">

        <header>
            <div class="logo">
                <img src="https://i.ibb.co/djz1G9j/shiro-logo-png.png" alt="Logo">
            </div>
        
            <div class="company-info">
                <h3>MÁY IN THẺ NHỰA CHÍNH HÃNG GIÁ SỈ</h3>
                <p>www.mayinthenhua.vn</p>
                <p>VP: 412 Nguyễn Thị Minh Khai, P5, Quận 3, TP.HCM</p>
                <p>cskh.mayinthenhua@gmail.com - Hotline: 089 8984 089</p>
            </div>

        </header>
        <!--
        <div>
            <p contenteditable="true" id="currentDate"></p>
        </div>
    -->
        <table id="info-table">
            <tr>
                <td colspan="4" > 
                    <div class="order-head">
                        <h1 style="text-align: center; display: flex; margin: 0px;">ĐƠN ĐẶT HÀNG</h1>
                        <p id="orderId" style="text-align: right; display: flex; margin: 0px;"></p>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Đơn vị mua</td>
                <td><strong>CÔNG TY TNHH SHIRO</strong></td>
                <td>Đơn vị bán</td>
                <td><strong id="company-name">CÔNG TY TNHH VIỆT ID</strong></td>
            </tr>
            <tr>
                <td style="width: 14%;">Địa chỉ giao</td>
                <td style="width: 36%;">Tầng 14, Tòa nhà HM Town, 412 Nguyễn Thị Minh Khai, Phường 05, Quận 3, Thành phố Hồ Chí Minh, Việt Nam.</td>
                <td style="width: 14%;">Địa chỉ</td>
                <td id="company-address">A2/1A Lê Văn Việt, Khu phố 2, Phường Tăng Nhơn Phú A,Thành phố Thủ Đức, Thành phố Hồ Chí Minh, Việt Nam.</td>
            </tr>
            <tr>
                <td>Mã số thuế</td>
                <td>0 3 1 5 5 3 6 1 4 7</td>
                <td>Mã số thuế</td>
                <td id="company-tax">0 3 1 2 1 3 4 7 4 6</td>
            </tr>
            <tr>
                <td>Người liên hệ</td>
                <td>Anh Tú</td>
                <td>Ngày đặt</td>
                <td  contenteditable="true" id="order-date"></td>
            </tr>
            <tr>
                <td>Điện thoại</td>
                <td>089.8984.089</td>
                <td>Điện thoại</td>
                <td contenteditable="true">082.6804.782</td>
                
            </tr>
            <tr>
                <td>Email</td>
                <td>ketoan.mayinthenhua@gmail.com</td>
                <td  contenteditable="true">Email</td>
                <td contenteditable="true">cskh.vietid@gmail.com</td>
            </tr>
        </table>

        <p>Công ty TNHH Shiro đặt hàng Quý công ty các mặt hàng sau:
        </p>
        <table class="product-table" id="product-table">

            <thead>
                <tr>
                    <th class="text-center"  style="width: 3%;">STT</th>
                    <th class="text-center" style="width: 40%;">Tên sản phẩm </th>
                    <th class="text-center" style="width: 6%;">Số lượng</th>
                    <th class="text-center" style="width: 15%;">Đơn giá <br>(VNĐ)</th>
                    
                    <th class="text-center" style="width: 15%;">Thành tiền <br> (VNĐ)</th>
                    <th class="text-center" style="width: 6%;">Thuế suất</th>
                    <th class="text-center" style="width: 15%;">Tiền thuế</th>
                    
                </tr>
            </thead>

            <tbody id="product-tbody">
                
            </tbody>
        </table>
        <div class="totalOrder">
           
        <p contenteditable="false">
        <b>GHI CHÚ</b>
        - Bên bán cung cấp hàng hóa theo chất lượng đúng như quy cách đặt hàng.
        - Phương thức thanh toán : Tiền mặt hoặc chuyển khoản.
        - Thời gian giao hàng: Giao ngay sau khi đặt hàng.
        - Nếu có các vấn đề phát sinh hai bên phải có thông báo với nhau ngay sau khi nhận được xác nhận đơn hàng. 
          Hai bên phối hợp với nhau xử lý các vấn đề phát sinh trong quá trình giao dịch.
        </p>

        </div>
        <footer class="footer">
            <div class="left-footer">
                <p> Xác nhận của đơn vị mua</p>
            </div>
            <div class="right-footer">
                <p id="label1">Xác nhận của đơn vị bán</p>
                <p >( Đóng dấu, ký tên đại diện công ty )</p>
            </div>
        </footer>
</div>
<hr/>
<div class="container" id="productContent">

    <div class="header2">
        
        <div class="left-header">
            <div style="display: flex;">
                <p style="padding: 0px; margin: 1px;"> <strong>Đơn vị: </strong></p>
                <p style="padding: 0px; margin: 1px;"><strong>CÔNG TY TNHH VIỆT ID</strong></p>
            </div>
            <div style="display: flex;">
                <p style="padding: 0px; margin: 1px;"> <strong>Địa chỉ: </strong></p>
                <p  id="company-address-short" style="padding: 0px; margin: 1px;"> A2/1A Lê Văn Việt, Tp. Thủ Đức</p>
            </div>
            <div style="display: flex;">
                <p style="padding: 0px; margin: 1px;"> <strong>MST: </strong></p>
                <p  id="company-address-short" style="padding: 0px; margin: 1px;">0312134746</p>
            </div>
        </div>
        <div class="right-header">
            <h1 style="text-align: center; margin-right: 100px;">PHIẾU GIAO HÀNG</h1>
        </div>
    </div>
    
    <!--
    <div>
        <p contenteditable="true" id="currentDate"></p>
    </div>
-->
    <div class="left-header">
        <div style="display: flex;">
            <p style="padding: 0px; margin: 1px;"> <strong>Tên khách hàng: </strong></p>
            <p style="padding: 0px; margin: 1px;"><strong id="CustomerName"></strong></p>
        </div>
        <div style="display: flex;">
            <p style="padding: 0px; margin: 1px;"> <strong>Địa chỉ: </strong></p>
            <p  id="CustomerAddress"  style="padding: 0px; margin: 1px;"></p>
        </div>
        <div style="display: flex;">
            <p style="padding: 0px; margin: 1px;"> <strong>Liên hệ:</strong></p>
            <p id="CustomerDetail"  style="padding: 0px; margin: 1px;">Anh Tú - 089.8984.089</p>
        </div>
    </div>
    
    <table class="product-table"  id="xProduct-table">

        <thead>
            <tr>
                <th class="text-center"  style="width: 2%;">STT</th>
                <th class="text-center" style="width: 33%;">Tên sản phẩm </th>
                <th class="text-center" style="width: 10%;">Số lượng</th>
                <th class="text-center" style="width: 15%;">Đơn giá</th>
                
                <th class="text-center" style="width: 15%;">Thành tiền</th>
                <th class="text-center" style="width: 8%;">VAT</th>
                <th class="text-center" style="width: 15%;">Tiền thuế</th>
                
            </tr>
        </thead>

        <tbody id="xProduct-tbody">
            
        </tbody>
    </table>
  
    <p  id="date-bill" style="margin:10px 2px 0px 0px; text-align: right;"></p>
    <footer class="footer">
        <div class="left-footer">
            <p style="margin:0px;">NGƯỜI NHẬN</p>
            <p style="margin-top:5px;">(ký và ghi rõ họ tên)</p>
        </div>
        <div class="right-footer">
            <p  style="margin:0px;">NGƯỜI BÁN HÀNG</p>
        </div>
    </footer>
</div>
    <script>
        let date={};
        let data;
        let subTotal;
        let vatTotal;
        let paymentTotal;
        let amountword;
        var numPages;

        let contentArray = [];
        var file;
        //let isTable = false;
        let pdfRead;
        function handleFile(e) {
            var files = e.target.files;
            var f = files[0];
            {
                var reader = new FileReader();
                var name = f.name;
                reader.onload = function (e) {
                    data = e.target.result;
                    parse_content(data,1); //btoa(arr));
                    randomOrderId();
                   
                };
                reader.readAsArrayBuffer(f);
            }
        }
        document.getElementById('pdfFileInput').addEventListener('change', handleFile, false);

        var parse_content = function (content,pageNumber) {
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.js';
            pdfjsLib.cMapUrl = 'https://mozilla.github.io/pdf.js/web/cmaps/';
            pdfjsLib.cMapPacked = true;

            var loadingTask = pdfjsLib.getDocument(content);
            var tbody = $('#product-tbody');
            var tbody1 = $('#xProduct-tbody');
            tbody.empty();
            tbody1.empty();
            const fileInput = document.getElementById('fileInput');
            const fileName =  $('#pdfFileInput').val().split('\\').pop();
            $('#filename').text(fileName||"Chưa chọn file");
            loadingTask.promise.then(function (doc){
                
                return pdf_table_extractor(doc,pageNumber);
            })
            .then(function (result) {
                numPages =result.numPages;
                $('#numPages').text('/' + numPages);
                $('#currentPage').attr('max',  numPages);
                console.log(result);
                if(result.numPages>1){
                    $('.pagination').removeClass('d-none');
                    $('.pagination').addClass('d-flex');

                }else{
                    $('.pagination').removeClass('d-flex');
                    $('.pagination').addClass('d-none');
                }
                while (page_tables = result.pageTables.shift()) {
                    table_dom = $('<table></table>').attr('border', 1);
                    var tables = page_tables.tables;
                    var merge_alias = page_tables.merge_alias;
                    var merges = page_tables.merges;
                    let isTable = false;
                    let isTotal = false;
                    let rowcnt=0;
                    for (var r = 0; r < tables.length; r++) {
                        
                        let tr_dom = $('<tr></tr>');
                        for (var c = 0; c < tables[r].length; c++) {
                            var r_c = [r, c].join('-');
                            if (merge_alias[r_c]) {
                                continue;
                            }
                            let td_dom = $('<td></td>');
                            if (merges[r_c]) {
                                isTotal = true;
                                if (merges[r_c].width > 1) {
                                    
                                    td_dom.attr('colspan', merges[r_c].width);
                                }
                                if (merges[r_c].height > 1) {
                                    td_dom.attr('rowspan', merges[r_c].height);
                                }
                            }
                            
                            let cell = tables[r][c];
                            if(cell.trim().length===0){
                                r++;c=-1;
                                continue;
                            }
                            if(r==0){
                                let lines = cell.split('\n');
                                let addr = findField('Address',cell);
                                let taxCode = findField('Tax Code',cell);
                                $('#company-name').text(lines[0]);
                                $('#company-address').text(addr);
                                $('#company-tax').text(taxCode);
                                if(addr.includes('Thủ Đức')){
                                    let addr_short = 'A2/1A Lê Văn Việt, TP. Thủ Đức, HCM'
                                    $('#company-address-short').text(addr_short);
                                }else{
                                    let addr_short ='A2/1A Lê Văn Việt, quận 9,TP HCM'
                                    $('#company-address-short').text(addr_short);
                                }
                            }
                            if(cell.includes('Ngày') && cell.includes('tháng')&& cell.includes('năm')){
                               let lines = cell.split('\n');
                               const index = lines.findIndex(str => str.includes('Ngày') &&str.includes('tháng')&& str.includes('năm'));
                               let dateLine = lines[index];
                               const n = dateLine.match(/\d+/g);
                               if(n){
                                    date.day = n[0];
                                    date.month = n[1];
                                    date.year = n[2];
                                    let dateString = date.year+'-'+date.month+'-'+date.day;
                                    let dateObject = new Date(dateString);

                                    let ran = Math.floor(Math.random() * 10) + 1;
                                    dateObject.setDate(dateObject.getDate() - ran);

                                    var newyear = dateObject.getFullYear();
                                    var newmonth = String(dateObject.getMonth() + 1).padStart(2, '0'); // Tháng 0-indexed, cần cộng 1
                                    var newday = String(dateObject.getDate()).padStart(2, '0');

                                    $('#order-date').text(`${newday}/${newmonth}/${newyear}`);
                                    $('#date-bill').text(`Ngày ${date.day} tháng ${date.month} năm ${date.year}`);
                               }
                            }
                            if(cell.toLowerCase().includes('người mua') && cell.includes('Mã số thuế')&& cell.includes('Địa chỉ')){
                                let line = cell.split('\n');
                                let customerAddress;
                                let customerName;
                                let buyer;
                                for(var i=0;i<line.length;i++){
                                    if(line[i].toLowerCase().includes('người mua')){
                                        buyer = line[i].split(':')[1];
                                        if(!line[i+1].includes(':')){
                                            buyer = buyer + ' ' + line[i+1];
                                        } 
                                    }
                                    if(line[i].includes('Company')){
                                        customerName = line[i].split(':')[1];
                                        if(!line[i+1].includes(':')){
                                            customerName = customerName + ' ' + line[i+1];
                                        } 
                                    }
                                    if(line[i].includes('Địa chỉ')){
                                        customerAddress = line[i].split(':')[1];
                                        if(!line[i+1].includes(':')){
                                            customerAddress = customerAddress + ' ' + line[i+1];
                                           
                                        } 
                                    }
                                }
                                if (customerName) {
                                    $('#CustomerName').text(customerName);
                                   
                                }
                                else{
                                    $('#CustomerName').text(buyer);
                                }
                                if(customerAddress){
                                    $('#CustomerAddress').text(customerAddress);
                                }
                            }
                            
                            if(cell.includes('STT')){
                                r+=2;c=-1;
                                isTable = true;
                                continue;
                            }
                            if(isTable===true && c!==2){
                                
                                
                                if (merges[r_c]) {
                                
                                    if (merges[r_c].width ===6) {
                                        td_dom.text(cell);
                                        td_dom.addClass('text-right');
                                        td_dom.addClass('row-sub');
                                    }
                                    if (merges[r_c].width ===2) {
                                        td_dom.html('<strong>'+cell+'</strong>');
                                        td_dom.addClass('text-right');
                                    }
                                    if (merges[r_c].width ===8) {
                                        let split = cell.split(':');
                                        td_dom.html( 'Số tiền viết bằng chữ'+': '+'<strong>'+split[1]+'</strong>');
                                        td_dom.addClass('text-left');
                                    }
                                }else{
                                    td_dom.text(cell);
                                    if(c===0 ||c===3||c===6){
                                    td_dom.addClass('text-center');
                                    }
                                    else if(c===4 ||c===5||c===7){
                                        td_dom.addClass('text-right');
                                    }
                                    else{
                                        td_dom.addClass('text-left');
                                    }
                                }
                                
                                tr_dom.append(td_dom);
                            }
                            
                        }
                        if(isTable===true){
                            let clonetr=tr_dom.clone();
                            tbody.append(tr_dom);
                            
                            tbody1.append(clonetr);
                            rowcnt++;
                            
                        }
                        
                        
                    }
                    let xProduct = document.getElementById("xProduct-table");
                  //  xProduct.deleteRow(rowcnt-1);
                  //  xProduct.deleteRow(rowcnt-2);
                    
                };
            });
        };
      
        function goToPage(){
            const pageInput = document.getElementById('currentPage').value;
            const newPage = parseInt(pageInput);
            parse_content(data,newPage);
            randomOrderId();
        }
        document.getElementById('btnOrderDownload').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const orderElementHTML = document.getElementById('orderContent');
            const producEelementHTML = document.getElementById('productContent');
           var opt = {
            margin: [0, 0, 0, 0],
                filename:     'document.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 4, logging: true, useCORS: true,dpi: 300 }, 
                jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
                };
                
          html2pdf().set(opt).from(orderElementHTML).toPdf().get('pdf').then(function(pdf) {
            pdf.save('đơn đặt hàng');

             });
        });
    
        
        document.getElementById('btnProductDownload').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const orderElementHTML = document.getElementById('orderContent');
            const producEelementHTML = document.getElementById('productContent');
           var opt = {
            margin: [0, 0, 0, 0],
                filename:     'document.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 4, logging: true, useCORS: true,dpi: 300 }, 
                jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
                };
                
          html2pdf().set(opt).from(producEelementHTML).toPdf().get('pdf').then(function(pdf) {

            pdf.save('phiếu giao hàng');

            });
        });
    function randomOrderId(){
        const generatedNumbers = new Set();
        let min = 1;
        let max = 999999;
        if (generatedNumbers.size >= (max - min + 1)) {
        throw new Error("All possible numbers have been generated");
        }
        
        let number;
        do {
            number = Math.floor(Math.random() * (max - min + 1)) + min;
        } while (generatedNumbers.has(number));
        
        generatedNumbers.add(number);
        let n = number.toString().padStart(7, '0');
        $('#orderId').html( `<strong style="margin-right: 2px;">Số: </strong>${`P`}${n} `) ;
       
    }
    function findField(find,cell){
        let lines = cell.split('\n');
        let index = lines.findIndex(line=>line.includes(find));
        let result = '';
        if(index>-1){
            result = lines[index].split(':')[1];
            for (let l = index+1; l < lines.length; l++) {
                
                if(!lines[l].includes(':')){
                    result += lines[l];
                }else{
                    break;
                }
            }
            result = result.replace('\n','');
        }
        return result;
    }
    </script>
</body>
</html>